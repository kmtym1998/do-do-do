html lang="ja"
    head
        meta charset="UTF-8"/
        meta name="viewport" content="width=device-width, initial-scale=1.0"/
        title Document
        script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"
        script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"
        / 本番環境 script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"
    body
        div#vm-container
            header

            main
                h1 タスク一覧

                = form_with url: js_ajax_create_path do |f|
                    = f.text_field :taskTitle, class: "input-task-title", "v-model": "newTaskTitle"
                    = f.submit '完了', class: "submit-task-title", "@click": "submitNewTask"

                div#tasks-container
                    -@tasks.reverse_each do |task|
                        div.task-container
                            li.task-title = task.title 
                            span.hidden.task-id = task.id
                            span.hidden.deadline = task.deadline
                            span.hidden.priority = task.priority
                            span.hidden.state = task.state
                            span.hidden.memo = task.memo

                div.modal-close#modal-background @click="hideModal"

                div.modal#modal-edit
                    div.modal-content#modal-edit-content
                        = form_with url: js_ajax_edit_path do |f|
                            = f.text_field :task_id, "v-model": "edittingTask.task_id"
                            = f.text_field :taskTitle, class: "input-edit", placeholder: "タスク名", "v-model": "edittingTask.title"
                            = f.datetime_field :deadline, class: "input-edit", "v-model": "edittingTask.deadline"
                            = f.select :priority, [["低", "0"], ["中", "1"], ["高", "2"]], "v-model": "edittingTask.priority"
                            = f.select :state, [["未着手", "0"], ["着手", "1"], ["完了", "2"]], "v-model": "edittingTask.state"
                            = f.text_area :memo, class: "input-edit", "v-model": "edittingTask.memo"
                            = f.submit '完了', class: "submit-task-title", "@click": "submitEditedTask"
            footer


    javascript:
        const vm = new Vue({
            el: '#vm-container',
            data: {
                newTaskTitle: '',
                edittingTask: {
                    task_id: '',
                    title: '',
                    deadline: '',
                    priority: '',
                    state: '',
                    memo: ''
                }
            },
            methods: {
                showModal: function(){
                    console.log('A click has been detected')
                },
                submitNewTask: function(){
                    console.log(this.newTaskTitle);
                },
                submitEditedTask: function(){

                    this.edittingTask.priority = $('#priority').val();
                    this.edittingTask.state = $('#state').val();

                    this.edittingTask.title = '';
                    this.edittingTask.deadline = '';
                    this.edittingTask.priority = '';
                    this.edittingTask.state = '';
                    this.edittingTask.memo = '';

                    this.hideModal();
                },
                editTask: function(event){
                    this.autoInput(event);
                    this.showModal($('#modal-edit'));
                    

                },
                showModal: function($target){
                    $($target).fadeIn();
                    $('#modal-background').fadeIn();
                    $('body').css('overflow', 'hidden');
                },
                hideModal: function(){
                    $('.modal').fadeOut();
                    $('#modal-background').fadeOut();
                    $('body').css('overflow', '');
                },
                autoInput: function(event){
                    const nodeList = event.target.parentNode.querySelectorAll('span'),
                          title = event.target.parentNode.querySelector('li').textContent,
                          task_id = Number(nodeList[0].textContent),
                          deadline = nodeList[1].textContent,
                          dateString = deadline.substr(0, 10) + 'T' + deadline.substr(11, 5),
                          priority = Number(nodeList[2].textContent),
                          state = Number(nodeList[3].textContent),
                          memo = nodeList[4].textContent;

                    this.edittingTask.task_id = task_id;
                    this.edittingTask.title = title;
                    this.edittingTask.deadline = dateString;
                    document.getElementById('priority').options[priority].selected = true; // なんかわからんけどバインドできない
                    document.getElementById('state').options[state].selected = true; // なんかわからんけどバインドできない
                    this.edittingTask.memo = memo;
                }
            }
        });

        // 本当はDBから取得したタスクのオブジェクトたちをVueで管理したい。このやり方は嫌
        $(document).on('click', '.task-container', function(event){
            vm.editTask(event);
        });

        function getDateString(now){
            let res = getYearToString(now.getFullYear());
            res += '-' + getMonthToString(now.getMonth() + 1);
            res += '-' + getDateToString(now.getDate());
            res += 'T' + getHourToString(now.getHours());
            res += ':' + getMinuteToString(now.getMinutes());
            return res;

            function getYearToString(year){
                return String(year);
            }
            function getMonthToString(month){
                if(month < 10){
                    return '0' + String(month);
                }else{
                    return String(month);
                }
            }
            function getDateToString(date){
                if(date < 10){
                    return '0' + String(date);
                }else{
                    return String(date);
                }
            }
            function getHourToString(hour){
                if(hour < 10){
                    return '0' + String(hour);
                }else{
                    return String(hour);
                }
            }
            function getMinuteToString(min){
                if(min < 10){
                    return '0' + String(min);
                }else{
                    return String(min);
                }
            }
        }